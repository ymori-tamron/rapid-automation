# **図面作成TOOL (Drawing Creation Tool) 解析レポート**

## **1\. プロジェクト概要**

本アプリケーションは、Excel VBAをプラットフォームとして動作する光学レンズ製造図面自動作成システムである。  
光学設計ソフト（CODE V等）が出力するシーケンスファイル（.seq）やパラメータを取り込み、レンズの物理形状計算を行った上で、2D CADソフト「図脳RAPID PRO（Photron製）」を外部制御し、製造用図面（部品図、組図、プレス図など）を自動生成する。

### **システムの目的**

* **工数削減:** 手動では膨大な時間を要するレンズ形状の作図、寸法記入、公差記入を自動化する。  
* **品質担保:** 転記ミスや計算ミス（サグ量計算など）を防ぎ、図面品質を均一化する。  
* **標準化:** レイヤー設定、線種、文字スタイルなどを統一し、社内規格に準拠した図面を出力する。

## **2\. システムアーキテクチャ**

本システムは、**Excel（UI/データ処理）** と **図脳RAPID（描画エンジン）** を **COM (ActiveX) オートメーション** で連携させる構成となっている。

### **構成要素**

1. **UI / Controller (Excel VBA)**  
   * リボンインターフェースによる操作 (basCLL, clsRibbonCtrl)  
   * ファイル入出力管理 (clsOpticalData, clsFileNameCtrl)  
   * パラメータ計算 (basUDF, clsGlassPlotData 等)  
2. **Drawing Engine (図脳RAPID)**  
   * OLEオートメーションサーバー zwDrawCAD.Application を経由して制御  
   * 作図コマンドの実行（線分、円弧、寸法線、バルーン等の生成）  
3. **Data Sources**  
   * **Input:** 光学設計データ (.seq ファイル)、硝材カタログ (.csv)、設定ファイル (.cfg, .ini)  
   * **Output:** CAD図面ファイル (.zfd), Excel帳票（仕様書、サグ表）

## **3\. 主要機能とワークフロー**

コード解析により判明した処理フローは以下の通りである。

### **Step 1: データのインポート (Import)**

* **CODE V連携:** .seq ファイル（光学設計データ）を解析し、Excelシート「光学データサマリ」へ展開。  
* **データ構造化:** 面番号、曲率半径(R)、面間隔(d)、硝種(Nd, Vd)、有効径などのパラメータを抽出。  
* **User Defined Functions (basUDF):**  
  * Sag: 非球面および球面のサグ量（深さ）計算  
  * FocalLength: 焦点距離計算  
  * GlassWeight: レンズ重量計算（積分計算を含む高度なロジック）  
  * PressValue: プレスレンズの芯取り代計算

### **Step 2: データ変換と正規化 (Convert)**

* 読み込んだデータを「部品単位（G01, G02...）」、「接合レンズ単位（B01...）」、「組立単位（Assy）」のシートに分割・展開。  
* 硝材データベース（Utility/Glasses-DataBase.xlsm）と照合し、メーカー名や物性値を補完。

### **Step 3: 自動作図 (Draw)**

図脳RAPIDを起動し、以下の要素を自動描画する。

1. **レンズ形状描画:**  
   * clsRapidLine: レンズ表面（球面/非球面）の描画。非球面はサグ量を計算し、微小線分の集合またはスプラインとして描画していると推測される。  
   * clsRapidGeo: 幾何公差（同軸度、平行度など）のシンボル描画。  
2. **寸法・注釈記入:**  
   * clsRapidDime: 外径、コバ厚、R寸法などの寸法線自動記入。  
   * clsRapidTol: 公差情報の記入（ニュートン本数、アスなど）。  
   * clsRapidPick: バルーン（風船出し）や引き出し線の作成。  
3. **枠・表題欄:**  
   * clsRapidHeader / clsRapidFooter: 図面枠、表題欄、注記の自動挿入。

### **Step 4: ユーティリティ**

* **一括リネーム:** ファイル名規則に従い、生成されたファイルを一括でリネーム。  
* **サグ表作成:** 非球面レンズの加工に必要なサグ量一覧表をExcelで生成。

## **4\. コード構造の詳細分析 (Python移行のための視点)**

### **クラス設計の評価**

VBAとしては非常に「オブジェクト指向」を意識した設計がなされており、機能ごとにクラスモジュール（cls）が分離されている。これはPythonへの移行において**非常に有利**である。

| VBAクラス | 機能概要 | Pythonでの移行方針 |
| :---- | :---- | :---- |
| clsOpticalData | 光学データのパース | pandas \+ 正規表現で.seq解析ロジックを実装 |
| clsGlassData | 硝材データ管理 | pandas DataFrame または sqlite で管理 |
| clsRapid... | CAD操作群 (APIラッパー) | pywin32 で Cad.Application をラップするクラスを作成 |
| basUDF | 数値計算関数 | numpy を使用してベクトル化・高速化 |
| clsIniFile/Cfg | 設定ファイル操作 | configparser または json/yaml 形式へ移行 |

### **技術的負債とリスク（現状の問題点）**

1. **Excel依存度の高さ:** データ保持にExcelの「セル位置（行・列）」を直接参照している箇所が多く（例: Cells(8, 3)）、レイアウト変更に弱い。  
   * *Pythonでの解決:* データをオブジェクトまたはDataFrameとしてメモリ内で扱うことで、Excelのセル位置依存を排除する。  
2. **計算ロジックの分散:** 一部の計算式がセル数式（Formula）として埋め込まれている（clsFormula）。  
   * *Pythonでの解決:* 全ての計算ロジックをPythonコード内に集約し、ブラックボックス化を防ぐ。  
3. **独自ファイル形式:** .seq ファイルのパースロジックが独自実装であり、フォーマット変更への追従が困難。

## **5\. Pythonプロジェクトへの推奨ロードマップ**

### **Phase 1: コアロジックの移植（非CAD部分）**

まず、CADに依存しない「計算」と「データ処理」部分をPython化する。

1. **光学計算ライブラリ化:** basUDF にある Sag, GlassWeight などを Python (numpy) で書き直す。  
2. **パーサー作成:** .seq ファイルを読み込み、構造化データ（JSON/Dict）に変換するモジュールを作成。

### **Phase 2: CAD制御の検証**

1. pywin32 を用いて、clsRapidDoc.Add や clsRapidLine に相当する「ラッパークラス」を作成する。  
2. VBAの zwDrawCAD オブジェクトモデルを調査し、Pythonから等価な操作（線を描く、寸法を入れる）ができるか検証する。

### **Phase 3: アプリケーション化**

1. CLI（コマンドライン）またはシンプルなGUI（Tkinter/PySide）を作成し、Excelリボンの代わりとする。  
2. 最終的な出力を図脳RAPIDへ送る。

## **6\. 結論**

このツールは、単なるマクロではなく\*\*「ドメイン知識の塊」です。開発者がコミュニケーションを取らないリスクは、この高度な光学計算ロジックとCAD制御ノウハウがブラックボックス化したまま失われることにあります。  
Pythonへの移行は、単なる言語の翻訳ではなく、「会社の技術資産（レンズ設計～製造のノウハウ）をコードとして明文化し、保全する」\*\*ための重要なプロジェクトとなります。