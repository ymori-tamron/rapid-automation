# VBAモジュール リファレンスドキュメント

本ドキュメントは、`references/VBA` ディレクトリに格納されているVBAコードの各モジュールについて、その目的（What/Why）を解説するものです。

---

## 目次

1. [標準モジュール (basXXX)](#1-標準モジュール-basxxx)
2. [クラスモジュール - システム制御系](#2-クラスモジュール---システム制御系)
3. [クラスモジュール - データ処理系](#3-クラスモジュール---データ処理系)
4. [クラスモジュール - CAD操作系 (clsRapidXXX)](#4-クラスモジュール---cad操作系-clsrapidxxx)
5. [クラスモジュール - 描画データ系](#5-クラスモジュール---描画データ系)
6. [クラスモジュール - ユーティリティ系](#6-クラスモジュール---ユーティリティ系)

---

## 1. 標準モジュール (basXXX)

### basMain.bas
**概要**: アプリケーションのメインエントリーポイントとなる標準モジュール

| 機能 | 目的 |
|------|------|
| `Import` | CODE Vシーケンスファイル(.seq)を読み込み、光学データをExcelテンプレートに展開する。光学設計データのインポート処理を担当 |
| `Convert` | インポートした光学データを部品単位（G01, B01等）のシートに変換・展開する。データの構造化と正規化を行う |
| `Reset` | リボンUIの状態をリセットし、再度データインポート可能な状態に戻す |
| `ImportCode` | 品目コード（材料コード等）をテキスト/CSVファイルから読み込み、各シートに反映する |
| `MakeSagTable` | 非球面レンズのサグ量一覧表をExcelで生成する。加工時の参照データとして使用 |
| `Draw` | 図脳RAPIDを起動し、図面を自動生成する。組図(Assy)、部品図(Glass)、プレス図(Press)の各モードに対応 |
| `OpenDataSummary` | データサマリーファイルを開き、関数リンクを修復する |
| `Rename` | 指定フォルダ内のファイルを、サマリーシートの情報に基づいて一括リネームする |
| `SwitchTolWindow` | 公差ウィンドウの表示/非表示を切り替える |

**なぜ必要か**: 図面作成ツールの核となる処理を集約し、Excelリボンから呼び出されるエントリーポイントとして機能する。

---

### basCLL.bas
**概要**: Excelリボンインターフェースのコールバック処理を担当するモジュール

| 機能 | 目的 |
|------|------|
| `Ribbon_Initialize` | リボン初期化時に設定ファイルを読み込み、ボタンの有効/無効状態を設定する |
| `Ribbon_ClickButton` | リボンボタンクリック時のイベントハンドラ。各機能を呼び出す |
| `Ribbon_SelectMenu` | ドロップダウンメニュー選択時の処理。シート切り替えや作図モード選択を処理 |
| `Ribbon_SetEnabled` | ボタンの有効/無効状態を動的に制御する |
| `Ribbon_SetVisible` | リボングループの表示/非表示を制御する |
| `Ribbon_SetContent` | ドロップダウンメニューの動的コンテンツを生成する |

**なぜ必要か**: ユーザーがExcelリボンから操作するための入口。ユーザビリティを高め、複雑な操作をボタン一つで実行可能にする。

---

### basCOM.bas
**概要**: コマンドウィンドウからの入力処理と、図脳RAPID連携コマンドを実装

| 機能 | 目的 |
|------|------|
| `OpenCmdWindow` | コマンド入力用ウィンドウを表示する |
| `ClickCmdButton` | コマンド入力に応じた処理を実行する（テキストコマンドによる操作） |
| `OpenGlaDB` | 硝材データベースを開く |
| `ImportRapid` | 図脳RAPIDから図面データをExcelのOLEオブジェクトとして取り込む |
| `OpenOLE` | Excel内のOLEオブジェクトを図脳RAPIDで開く |
| `SaveRapid` | 図脳RAPIDで開いている全図面を指定フォルダに保存する |
| `PrintRapid` | 図脳RAPIDで開いている全図面を印刷する |
| `MakeXltx` | Excelテンプレートファイル(.xltx)を生成する |

**なぜ必要か**: コマンドラインインターフェースを提供し、高度なユーザーが効率的に操作できるようにする。また、CADとの連携処理を集約する。

---

### basUDF.bas
**概要**: 光学計算に関するユーザー定義関数(UDF)を提供

| 関数 | 目的 |
|------|------|
| `Sag` | レンズ表面のサグ量（深さ）を計算する。球面・非球面の両方に対応。レンズ形状の数値計算の基礎 |
| `FocalLength` | 単レンズの焦点距離を計算する。薄肉レンズの公式に基づく |
| `GlassWeight` | 単レンズの重量を積分計算で算出する。非球面形状にも対応 |
| `NewtonToDeltaRadius` | ニュートンリング本数を曲率半径の公差に換算する。品質検査用の換算式 |
| `PressValue` | プレスレンズの芯取り代（プレス径−研磨径）を直径差で計算する |
| `Load_UDFHelp` | 上記関数のExcel関数ヘルプを登録する |

**なぜ必要か**: 光学設計に必要な計算ロジックをExcel関数として提供し、セル数式で使用可能にする。これにより、光学データからレンズ形状を数値化できる。

---

## 2. クラスモジュール - システム制御系

### clsAppEvent.cls
**概要**: Excelアプリケーションイベントをハンドリングするクラス

| 機能 | 目的 |
|------|------|
| ワークブック終了前の処理 | 硝材DBの状態管理、公差ウィンドウの誤操作防止 |
| シート/ウィンドウ切り替え時の処理 | リボンUI状態の同期、メニューコンテンツの更新 |

**なぜ必要か**: ユーザー操作（シート切替、ブック終了等）に応じてUIを適切に更新し、一貫した操作性を維持する。

---

### clsRibbonCtrl.cls
**概要**: リボンUIの状態管理を行うクラス

| 機能 | 目的 |
|------|------|
| `SetEnabled` | 指定したボタンの有効/無効状態を変更する |
| `SetVisible` | 指定したグループの表示/非表示を変更する |
| `SetContent` | ドロップダウンメニューの内容を動的に生成する（シート一覧等） |

**なぜ必要か**: 現在の作業状態に応じてリボンUIを動的に更新し、無効な操作を防止する。

---

### clsWindowCtrl.cls
**概要**: Excelウィンドウの分割・配置を管理するクラス

| 機能 | 目的 |
|------|------|
| `OpenWn` | メインウィンドウと公差ウィンドウを並列表示する |
| `CloseWn` | 分割ウィンドウを閉じ、元のレイアウトに戻す |
| `Search` | アクティブシートに対応する公差データの列位置を検索する |

**なぜ必要か**: 光学データと公差データを同時に参照しながら作業できる画面レイアウトを提供する。

---

### clsProgCtrl.cls
**概要**: 処理進捗バーの表示・更新を管理するクラス

| 機能 | 目的 |
|------|------|
| `InitBar1` / `InitBar2` | 進捗バーを初期化する（全体/詳細の2段階） |
| `AddBar` | 進捗を進める |

**なぜ必要か**: 時間のかかる図面生成処理中に進捗状況をユーザーに表示し、フリーズしていないことを示す。

---

### clsError.cls
**概要**: エラーチェックとメッセージ表示を担当するクラス

| 機能 | 目的 |
|------|------|
| `CheckConvert` | データ変換前のブック状態をチェックする |
| `CheckSummary` | サマリーシートの有効性をチェックする |
| `CheckRapidExists` | 図脳RAPIDにドキュメントが存在するかチェックする |
| `CheckRapidMatch` | 図脳RAPIDのドキュメントがExcelデータと一致するかチェックする |
| `Message` | エラーコードに応じたメッセージダイアログを表示する |

**なぜ必要か**: 処理前の事前チェックを行い、不正な操作や状態を早期に検出してユーザーに通知する。

---

## 3. クラスモジュール - データ処理系

### clsOpticalData.cls
**概要**: CODE Vシーケンスファイル(.seq)のパーサー

| 機能 | 目的 |
|------|------|
| `Add` | .seqファイルを解析し、光学データ（面番号、曲率半径、間隔、硝種、非球面係数等）をExcelシートに展開する |

**なぜ必要か**: 光学設計ソフトからのデータインポートを可能にし、手入力によるミスを防止する。

---

### clsGlassData.cls
**概要**: 部品シート（G01, B01等）のデータ生成・設定を行うクラス

| 機能 | 目的 |
|------|------|
| `AddA` | 組図シート(G00)用のデータを設定する。光学仕様・注記等を生成 |
| `AddG` | 単レンズシート(Gxx)用のデータを設定する。形状・寸法データを生成 |
| `AddB` | 接合レンズシート(Bxx)用のデータを設定する |
| `AddM` | ハイブリッドレンズシート(Mxx)用のデータを設定する |

**なぜ必要か**: インポートした光学データを部品単位に変換し、図面作成に必要な形式に整形する。

---

### clsToleranceData.cls
**概要**: 公差データシートの生成・設定を行うクラス

| 機能 | 目的 |
|------|------|
| `AddG` | 部品シートに対応する公差値（ニュートン、アス、中心厚公差、外径公差等）を自動計算・設定する |

**なぜ必要か**: 設計データから公差を自動算出し、公差管理シートを自動生成する。これにより公差設定の手間を削減する。

---

### clsGlaDB.cls
**概要**: 硝材データベースとの連携を管理するクラス

| 機能 | 目的 |
|------|------|
| `Load` | 硝材データベースファイルを開き、現在のデータと関連付ける |
| `PickUp` | 硝材DBから代替硝種を検索・取得する |
| `ClearSumInfo` | 関連付け情報をクリアする |

**なぜ必要か**: 硝材メーカーのカタログデータを参照し、代替材料の検索・設定を効率化する。

---

### clsMaterialCode.cls
**概要**: 品目コード（材料コード）のインポート・適用を行うクラス

| 機能 | 目的 |
|------|------|
| `ReadCode` | テキスト/CSVファイルから品目コードを読み込む |
| `WriteCode` | 各部品シートに品目コードを書き込む |

**なぜ必要か**: 外部システムの品目コードを図面データに反映させ、トレーサビリティを確保する。

---

### clsPressParam.cls
**概要**: プレス成形パラメータの管理クラス

| 機能 | 目的 |
|------|------|
| `Import` | 設定ファイルからプレスパラメータ（径規格、厚み公差、C面取り、R面取り等）を読み込む |
| 各種Property | パラメータ値へのアクセスを提供する |

**なぜ必要か**: プレス図面作成時に参照する加工規格値を一元管理する。

---

### clsIniFile.cls
**概要**: INI形式設定ファイルの読み書きを行うクラス

| 機能 | 目的 |
|------|------|
| `FileToArray` | INIファイルを読み込み、グローバル配列に格納する |
| `FileToForm` | INIファイルを読み込み、設定フォームに反映する |
| `FormToFile` | 設定フォームの内容をINIファイルに保存する |

**なぜ必要か**: ユーザー設定（レイヤー番号、表示オプション等）を永続化する。

---

### clsCfgFile.cls
**概要**: 設定ファイル(.cfg)の管理クラス

| 機能 | 目的 |
|------|------|
| `OpenFile` | 設定ファイルを開いてExcelシートに展開する |
| `OverWrite` | 編集した内容で設定ファイルを上書き保存する |
| `PlotMark` | テキスト座標設定ファイルを基に、図面テンプレート上に確認用マークを描画する |

**なぜ必要か**: 図面レイアウト設定のカスタマイズと確認を可能にする。

---

### clsFileNameCtrl.cls
**概要**: ファイルの一括リネーム機能を提供するクラス

| 機能 | 目的 |
|------|------|
| `RenameBySummary` | サマリーシートの情報に基づき、指定フォルダ内のファイルを一括リネームする |
| `ListRename` | リネーム対象とリネーム後のファイル名一覧をExcelで表示する |
| `RenameByLogFile` | ログファイルを基にリネームを元に戻す |

**なぜ必要か**: 図面ファイルの命名規則に沿ったリネームを自動化し、ミスを防止する。

---

### clsSagTable.cls
**概要**: 非球面サグ量一覧表の生成クラス

| 機能 | 目的 |
|------|------|
| `PickUp` | 非球面データをシートから収集する |
| `Export` | サグ量一覧表をExcelテンプレートに出力する |

**なぜ必要か**: 非球面レンズ加工に必要なサグ量の参照データを生成する。

---

### clsFuncLinkCtrl.cls
**概要**: Excel関数リンクの管理クラス

| 機能 | 目的 |
|------|------|
| `OpenAndRemove` | データサマリーファイルを開き、壊れた関数リンクを修復する |

**なぜ必要か**: アドインファイルのパス変更時に、既存ファイルのリンク切れを修復する。

---

### clsXltxFile.cls
**概要**: Excelテンプレートファイル(.xltx)の生成・変換クラス

| 機能 | 目的 |
|------|------|
| `DataSummary` | データサマリーテンプレートを新規作成する |
| `SagTable` | サグテーブルテンプレートを作成する |
| `RenameList` | リネーム一覧テンプレートを作成する |
| `OldToNew` | 旧形式のテンプレートを新形式に変換する |

**なぜ必要か**: 業務で使用するExcelテンプレートの生成・メンテナンスを自動化する。

---

## 4. クラスモジュール - CAD操作系 (clsRapidXXX)

### clsRapidDoc.cls
**概要**: 図脳RAPIDドキュメントの作成・初期設定を行うクラス

| 機能 | 目的 |
|------|------|
| `Add` | 新規図面を作成し、テンプレートを読み込み、レイヤー設定等を行う |

**なぜ必要か**: 図面作成の起点となる処理。図枠やレイヤー構成を統一し、社内規格に準拠した図面を生成する。

---

### clsRapidCtrl.cls
**概要**: 図脳RAPIDとExcel間のデータ連携を制御するクラス

| 機能 | 目的 |
|------|------|
| `RapidToOLE` | 図脳RAPIDの図面をExcelのOLEオブジェクトとして取り込む |
| `OLEToRapid` | ExcelのOLEオブジェクトを図脳RAPIDで開く |
| `TemporaryFolder` | 一時ファイル用フォルダの作成・クリーンアップを行う |
| `AllSave` | 開いている全図面を保存する |
| `AllPrint` | 開いている全図面を印刷する |

**なぜ必要か**: CADとExcel間の双方向データ連携を実現する。

---

### clsRapidOperate.cls
**概要**: 図面作成の全体制御を行うオーケストレータークラス

| 機能 | 目的 |
|------|------|
| `Run` | シートタイプ（組図/部品図/プレス図等）を判別し、適切な描画処理を呼び出す |

**なぜ必要か**: 図面種別に応じた描画処理のディスパッチを行い、複雑な分岐ロジックを一元管理する。

---

### clsRapidLine.cls
**概要**: レンズ形状（輪郭線）の描画を行うクラス

| 機能 | 目的 |
|------|------|
| `AddG` | 単レンズの形状線を描画する（球面は円弧、非球面は微小線分の集合） |
| `AddP` | プレスレンズの形状線を描画する |

**なぜ必要か**: レンズの物理形状を正確にCAD図面として描画する。サグ量計算結果を反映した形状線を生成する。

---

### clsRapidDime.cls
**概要**: 寸法線の自動記入を行うクラス

| 機能 | 目的 |
|------|------|
| `AddG` | 単レンズ図面に寸法線（中心厚、コバ厚、外径、R寸法等）を記入する |
| `AddP` | プレス図面に寸法線を記入する |
| `AddB` | 接合レンズ図面に寸法線を記入する |
| `AddA` | 組図に寸法線（間隔寸法等）を記入する |

**なぜ必要か**: 手作業では時間のかかる寸法記入を自動化し、記入ミスを防止する。

---

### clsRapidPick.cls
**概要**: 引き出し線とバルーンの描画を行うクラス

| 機能 | 目的 |
|------|------|
| `AddG` | 単レンズ図面にR記号、C面取り記号等の引き出し線を描画する |
| `AddP` | プレス図面に引き出し線を描画する |
| `AddA` | 組図にバルーン（部品番号）を描画する |

**なぜ必要か**: 図面の注釈情報を自動配置し、見やすい図面を生成する。

---

### clsRapidGeo.cls
**概要**: 幾何公差記号の描画を行うクラス

| 機能 | 目的 |
|------|------|
| `AddG` | 単レンズ図面に幾何公差（同軸度、平行度等）のシンボルを描画する |

**なぜ必要か**: 光学部品に必要な幾何公差記号を規格に準拠した形式で描画する。

---

### clsRapidTol.cls
**概要**: 寸法公差値の描画を行うクラス

| 機能 | 目的 |
|------|------|
| `AddG` | 単レンズ図面の寸法に公差値を付加する |
| `AddA` | 組図の間隔寸法に公差値を付加する |
| `Check` | 公差データの有無をチェックする |

**なぜ必要か**: 公差管理シートの値を図面の寸法線に反映する。

---

### clsRapidText.cls
**概要**: テキスト要素の描画を行うクラス

| 機能 | 目的 |
|------|------|
| `Add` | 図面上の指定座標にテキストを描画する（図面枠内の情報等） |
| `AddE` | 非球面サグデータ一覧をテキストで描画する |
| `AddP` | プレス図面用のテキストを描画する |

**なぜ必要か**: 設定ファイルに基づき、図面上の適切な位置にテキスト情報を自動配置する。

---

### clsRapidHeader.cls
**概要**: 組図ヘッダー部の描画（焦点距離情報等）を行うクラス

| 機能 | 目的 |
|------|------|
| `AddA` | 組図上部に焦点距離、有効径、コバ厚等の情報表を描画する |

**なぜ必要か**: 組図上に光学仕様をまとめた情報表を自動生成する。

---

### clsRapidFooter.cls
**概要**: 組図フッター部の描画（品番バルーン等）を行うクラス

| 機能 | 目的 |
|------|------|
| `AddA` | 組図下部に部品番号バルーンと識別記号を描画する |

**なぜ必要か**: 組図の品番表記を標準フォーマットで自動生成する。

---

### clsRapidLayout.cls
**概要**: 組図のレイアウト寸法（間隔寸法）の描画を行うクラス

| 機能 | 目的 |
|------|------|
| `AddA` | 組図にレンズ間隔寸法を描画する。ズームポジション対応 |

**なぜ必要か**: 光学系の配置寸法を自動記入し、組立情報を明確にする。

---

### clsRapidTable.cls
**概要**: 仕様表の描画を行うクラス

| 機能 | 目的 |
|------|------|
| `AddA` | 組図に光学仕様表（EFL、OVL、FNO等）を描画する |

**なぜ必要か**: 光学仕様を表形式で図面上に自動配置する。

---

### clsRapidEdit.cls
**概要**: 図面要素の編集（移動、削除等）を行うクラス

| 機能 | 目的 |
|------|------|
| `EditAspFrame` | 非球面図面のフレーム位置を調整する（片面のみ非球面の場合） |
| `EditGlaDBBlank` | 硝材DB情報が未設定の場合に取り消し線を描画する |
| `RemoveGmNote` | 不要な注記要素を削除する |
| `RemoveExStd` | 不要な規格表示を削除する |
| `CreatePressBase` | プレス図面のベース要素を作成する |

**なぜ必要か**: テンプレートを状況に応じて編集し、適切な図面を生成する。

---

### clsRapidParam.cls
**概要**: 描画パラメータの管理クラス

| 機能 | 目的 |
|------|------|
| `Import` | 設定ファイルから描画パラメータ（座標、サイズ、フォント等）を読み込む |
| `SetUp` | 寸法/引き出し線パラメータを図脳RAPIDに設定する |

**なぜ必要か**: 描画設定を外部ファイルで管理し、カスタマイズを容易にする。

---

### clsRapidPrim.cls
**概要**: 図面プリミティブ（線、円等）の共通設定を行うクラス

| 機能 | 目的 |
|------|------|
| `SetUp` | プリミティブにレイヤー番号、線種、線幅を設定する |

**なぜ必要か**: 全ての描画要素に統一した設定を適用し、図面の一貫性を保つ。

---

## 5. クラスモジュール - 描画データ系

### clsGlassPlotData.cls
**概要**: 単レンズの描画データを計算・保持するクラス

| 機能 | 目的 |
|------|------|
| `Calc` | レンズ形状（サグ量、コーナー座標等）を計算し、描画用データを生成する |
| 各種Property | 計算結果（曲率半径、中心座標、コーナー位置、サグ配列等）へのアクセスを提供 |

**なぜ必要か**: Excelシートの光学データから描画に必要な座標値を算出する。

---

### clsPressPlotData.cls
**概要**: プレスレンズの描画データを計算・保持するクラス

| 機能 | 目的 |
|------|------|
| `Calc` | プレス形状（規格丸め後のR、C面取り、外径等）を計算し、描画用データを生成する |
| 各種Property | 計算結果へのアクセスを提供 |

**なぜ必要か**: 加工規格に合わせたプレス形状を算出する。

---

### clsAssyPlotData.cls
**概要**: 組図の描画データを計算・保持するクラス

| 機能 | 目的 |
|------|------|
| `Calc` | 組立構成（各レンズの位置、間隔、最大径等）を計算する |
| `CreateElement` | 組図上に各レンズ形状を描画する |
| 各種Property | 計算結果（レンズ配置、全長、中心位置等）へのアクセスを提供 |

**なぜ必要か**: 光学系全体の組立図を生成するための配置計算を行う。

---

### clsBalsamPlotData.cls
**概要**: 接合レンズの描画データを計算・保持するクラス

| 機能 | 目的 |
|------|------|
| `PreCalc` | 接合レンズの最大径等を事前計算する |
| `CreateElement` | 接合レンズの形状を描画する |
| 各種Property | 接合面座標、コーナー位置等へのアクセスを提供 |

**なぜ必要か**: 2枚以上のレンズを接合した複合レンズの形状を描画する。

---

## 6. クラスモジュール - ユーティリティ系

### clsFormula.cls
**概要**: Excel数式セルの書式設定を行うユーティリティクラス

| 機能 | 目的 |
|------|------|
| `SetUp` | セルに数式を設定し、計算式であることを示す背景色を適用する |

**なぜ必要か**: 数式セルを視覚的に識別可能にし、誤編集を防止する。

---

### clsBorder.cls
**概要**: Excel罫線の一括設定を行うユーティリティクラス

| 機能 | 目的 |
|------|------|
| `SetUp` | 指定範囲に標準的な罫線（細線）を設定する |

**なぜ必要か**: 表形式データの罫線設定を統一する。

---

## モジュール間の関係

```
┌─────────────────────────────────────────────────────────────────┐
│                    ユーザーインターフェース層                      │
│  basCLL.bas (リボンUI) ← clsRibbonCtrl.cls (状態管理)           │
│  basCOM.bas (コマンド)                                            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      メイン制御層                                  │
│  basMain.bas (Import/Convert/Draw等)                              │
│  clsRapidOperate.cls (描画処理オーケストレーション)               │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────┬──────────────────────────────────────────┐
│    データ処理層       │              CAD描画層                    │
│                       │                                          │
│ clsOpticalData.cls    │  clsRapidDoc.cls (図面作成)             │
│ clsGlassData.cls      │  clsRapidLine.cls (形状線)              │
│ clsToleranceData.cls  │  clsRapidDime.cls (寸法線)              │
│ clsPressParam.cls     │  clsRapidPick.cls (引き出し線)          │
│ clsGlaDB.cls          │  clsRapidGeo.cls (幾何公差)             │
│                       │  clsRapidText.cls (テキスト)            │
│ ↓                     │  clsRapidHeader/Footer/Layout/Table.cls │
│ 描画データ計算         │                                          │
│ clsGlassPlotData.cls  │                                          │
│ clsPressPlotData.cls  │                                          │
│ clsAssyPlotData.cls   │                                          │
│ clsBalsamPlotData.cls │                                          │
└──────────────────────┴──────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                     計算関数層                                     │
│  basUDF.bas (Sag, FocalLength, GlassWeight, PressValue等)        │
└─────────────────────────────────────────────────────────────────┘
```

---

## まとめ

このVBAアプリケーションは、以下の目的を達成するために設計されています：

1. **工数削減**: 光学設計データから図面を自動生成することで、手作業の時間を大幅に削減
2. **品質担保**: サグ量計算や公差算出を自動化し、計算ミス・転記ミスを防止
3. **標準化**: レイヤー設定、線種、文字スタイル等を統一し、社内規格に準拠した図面を出力

モジュールはオブジェクト指向的に設計されており、Pythonへの移行を考慮すると、各クラスの責務が明確に分離されている点が有利です。

